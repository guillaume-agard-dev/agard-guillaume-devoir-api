<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="dashboard.css" />
    <title>Tableau de bord - Russell</title>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo">Russell</div>
        <ul class="nav-links">
          <li><a href="/catways.html">Catways</a></li>
          <li><a href="/reservations.html">Réservations</a></li>
          <li><a href="/users.html">Utilisateurs</a></li>
          <li><a href="/docs.html" target="_blank">Documentation</a></li>
          <li><button id="logout-btn">Déconnexion</button></li>
        </ul>
      </nav>
      <h1>Tableau de bord</h1>
    </header>

    <main>
      <p>
        <strong>Utilisateur connecté :</strong> <span id="user-info">Chargement...</span>
      </p>
      <p><strong>Date du jour :</strong> <span id="today-date"></span></p>

      <h2>Réservations en cours</h2>
      <table>
        <thead>
          <tr>
            <th>Catway</th>
            <th>Client</th>
            <th>Bateau</th>
            <th>Début</th>
            <th>Fin</th>
          </tr>
        </thead>
        <tbody id="reservations-table">
          <tr>
            <td colspan="5">Chargement...</td>
          </tr>
        </tbody>
      </table>
    </main>

    <script>
    // Afficher la date du jour
    document.getElementById('today-date').textContent = new Date().toLocaleDateString('fr-FR');

    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = "/";
    }

    // Récupérer l'utilisateur connecté depuis l'API
    async function loadUser() {
      try {
        const res = await fetch('/users/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Token invalide ou expiré');
        const user = await res.json();
        document.getElementById('user-info').textContent = `${user.username} (${user.email})`;
      } catch (err) {
        console.error(err);
        localStorage.removeItem('token');
        window.location.href = "/";
      }
    }
    loadUser();

    // Charger les réservations depuis l'API
    async function loadReservations() {
      try {
        const res = await fetch('/reservations', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Impossible de récupérer les réservations');
        const data = await res.json();
        const tbody = document.getElementById('reservations-table');
        tbody.innerHTML = '';
        data.forEach(r => {
          const row = `
            <tr>
              <td>${r.catwayNumber}</td>
              <td>${r.clientName}</td>
              <td>${r.boatName}</td>
              <td>${new Date(r.startDate).toLocaleDateString('fr-FR')}</td>
              <td>${new Date(r.endDate).toLocaleDateString('fr-FR')}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      } catch (err) {
        console.error(err);
        const tbody = document.getElementById('reservations-table');
        tbody.innerHTML = '<tr><td colspan="5">Erreur lors du chargement des réservations</td></tr>';
      }
    }
    loadReservations();

    // Déconnexion
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = "/";
    });
    </script>

  </body>
</html>
